<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kulam ‚Äî Tamil Brahmin Family Network</title>
  <meta name="description" content="Community family tree with admin approvals" />
  <style>
    /* Reset + base */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#app{height:100%}
    body{font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#222}
    a{color:inherit}
    /* Layout */
    .centered{display:flex;align-items:center;justify-content:center}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}

    /* Header */
    .header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:18px;color:#fff}
    .brand{font-size:1.6rem;font-weight:700;display:flex;align-items:center;gap:10px}
    .brand .logo{background:#fff;color:#764ba2;border-radius:8px;padding:6px 8px;font-weight:700}

    /* Layout inside card */
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}.header{flex-direction:column;align-items:flex-start}}

    /* Left panel: actions */
    .panel{display:flex;flex-direction:column;gap:12px}
    label{font-size:0.9rem;color:#444;margin-bottom:6px}
    .input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;font-size:0.95rem}
    .btn{display:inline-block;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.secondary{background:#f4f6f9;color:#333;border:1px solid #e6e9ee}
    .muted{color:#666;font-size:0.9rem}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.08);cursor:pointer}
    .tab.active{background:#fff;color:#333;box-shadow:0 6px 18px rgba(0,0,0,0.08)}

    /* Search results */
    .results{max-height:320px;overflow:auto;border-radius:8px;border:1px solid #f0f2f4;padding:8px}
    .result-item{padding:10px;border-bottom:1px dashed #f1f3f5;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .result-item:last-child{border-bottom:none}

    /* Family map preview */
    .family-map{background:#fbfdff;padding:14px;border-radius:10px;border:1px solid #eef3fb}
    .node{display:inline-block;padding:10px 12px;border-radius:10px;margin:8px;border:1px solid #e6e9ee;background:#fff;min-width:140px;text-align:center}
    .node.current{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;border:2px solid #ff6b6b}
    .node.missing{background:#f7f7f7;color:#9a9a9a;border:1px dashed #ddd}

    /* Admin badge */
    .badge{background:#ffd965;color:#5b3f00;padding:6px 8px;border-radius:999px;font-weight:700}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:1200}
    .modal{background:#fff;border-radius:12px;padding:18px;max-width:900px;width:100%;box-shadow:0 16px 40px rgba(0,0,0,0.25)}

    footer{color:#fff;text-align:center;margin-top:18px}

    /* small helpers */
    .flex{display:flex;gap:8px;align-items:center}
    .spacer{flex:1}
    .small{font-size:0.85rem;color:#666}

  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <div class="header">
        <div class="brand"><span class="logo">üïâÔ∏è</span> Kulam ‚Äî Tamil Brahmin Family Network</div>
        <div class="flex">
          <div id="currentState" class="muted">Not signed in</div>
          <div style="width:10px"></div>
          <button id="btnSignOut" class="btn secondary" style="display:none" onclick="signOut()">Sign out</button>
        </div>
      </div>

      <!-- main card -->
      <div class="card">
        <div class="grid">
          <!-- left control panel -->
          <div>
            <div style="margin-bottom:12px">
              <strong>Access & Account</strong>
              <div class="small muted">Only admin-approved members can access the site. Sign up, then wait for admin approval.</div>
            </div>

            <div id="authPanel">
              <!-- Request access (optional) -->
              <div id="requestForm">
                <label>Community Access Code (optional)</label>
                <input id="accessCode" class="input" placeholder="Enter community access code (if provided)" value="kulam2025">

                <label style="margin-top:8px">Your Full Name</label>
                <input id="fullName" class="input" placeholder="e.g. Krishnan Iyer">

                <label style="margin-top:8px">Father's Name</label>
                <input id="fatherName" class="input" placeholder="e.g. Srinivasan Iyer">

                <label style="margin-top:8px">Email (used to sign in)</label>
                <input id="email" class="input" type="email" placeholder="your.email@example.com">

                <div style="margin-top:10px;display:flex;gap:8px">
                  <button class="btn" id="btnRequest" onclick="requestAccess()">Request Access</button>
                  <button class="btn secondary" onclick="showAuthOptions()">Sign Up / Sign In</button>
                </div>

                <div id="requestMessage" class="small muted" style="margin-top:10px"></div>
              </div>

              <!-- Auth options (Sign Up / Sign In) -->
              <div id="authOptions" style="display:none;margin-top:12px">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" onclick="showSignUp()">Create account</button>
                  <button class="btn secondary" onclick="showLogin()">Sign in</button>
                </div>
              </div>

              <!-- Sign up form -->
              <div id="signUpForm" style="display:none;margin-top:12px">
                <label>Email</label>
                <input id="signupEmail" class="input" type="email" placeholder="your.email@example.com">
                <label style="margin-top:8px">Choose a password</label>
                <input id="signupPassword" class="input" type="password" placeholder="minimum 6 characters">
                <label style="margin-top:8px">Full name</label>
                <input id="signupFullName" class="input" placeholder="Your full name">
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button class="btn" onclick="signUp()">Create account</button>
                  <button class="btn secondary" onclick="hideAuthForms()">Cancel</button>
                </div>
                <div id="signupMessage" class="small muted" style="margin-top:8px"></div>
              </div>

              <!-- Sign in form -->
              <div id="loginForm" style="display:none;margin-top:12px">
                <label>Email</label>
                <input id="loginEmail" class="input" type="email" placeholder="your.email@example.com">
                <label style="margin-top:8px">Password</label>
                <input id="loginPassword" class="input" type="password" placeholder="Your password">
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button class="btn" onclick="signIn()">Sign in</button>
                  <button class="btn secondary" onclick="hideAuthForms()">Cancel</button>
                </div>
                <div id="loginMessage" class="small muted" style="margin-top:10px"></div>
              </div>

            </div>

            <!-- admin controls (only visible to admin) -->
            <div id="adminPanel" style="margin-top:16px;display:none">
              <strong>Admin Panel</strong>
              <div class="small muted">Approve/block members and manage requests.</div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" onclick="openAdminModal()">Open Admin Dashboard</button>
              </div>
            </div>

            <div style="margin-top:18px">
              <strong>Quick Actions</strong>
              <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
                <button class="btn secondary" onclick="showTab('search')">üîé Find Family</button>
                <button class="btn secondary" onclick="showTab('myNetwork')">üå≥ My Network</button>
                <button class="btn secondary" onclick="showTab('explore')">üß≠ Explore</button>
              </div>
            </div>

            <div style="margin-top:18px" class="small muted">Notes: Replace the firebaseConfig object (below) with your Firebase project's configuration and enable Email/Password auth.</div>

          </div>

          <!-- right content area -->
          <div>
            <div class="tabs" id="tabs">
              <div class="tab active" data-tab="search" onclick="showTab('search')">Find My Family</div>
              <div class="tab" data-tab="myNetwork" onclick="showTab('myNetwork')">My Network</div>
              <div class="tab" data-tab="explore" onclick="showTab('explore')">Explore Families</div>
              <div class="tab" data-tab="addFamily" onclick="showTab('addFamily')">Add Family</div>
            </div>

            <div style="margin-top:12px">
              <!-- SEARCH TAB -->
              <div id="tab-search">
                <div class="card" style="margin-bottom:12px">
                  <strong>Search by name or family code</strong>
                  <div class="small muted">Results show only public fields (Name, Place, Gothram). Request more details from admin.</div>
                  <div style="margin-top:10px;display:flex;gap:8px">
                    <input id="searchInput" class="input" placeholder="Type name or family code..." oninput="debouncedSearch()">
                    <button class="btn secondary" onclick="clearSearch()">Clear</button>
                  </div>
                </div>

                <div id="searchResults" class="results"></div>
              </div>

              <!-- MY NETWORK TAB -->
              <div id="tab-myNetwork" style="display:none">
                <div class="card">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <strong>My Family Preview</strong>
                    <div>
                      <span class="badge">Private Data Hidden</span>
                    </div>
                  </div>

                  <div style="margin-top:10px" id="myNetworkArea">
                    <div class="family-map" id="familyPreview">No family selected</div>
                  </div>

                  <div style="margin-top:12px;display:flex;gap:8px">
                    <button class="btn" onclick="requestExport()">Request Full Details (Admin)</button>
                    <button class="btn secondary" onclick="shareFamilyLink()">Get Family Code</button>
                  </div>
                </div>
              </div>

              <!-- EXPLORE TAB -->
              <div id="tab-explore" style="display:none">
                <div class="card">
                  <strong>Explore Families</strong>
                  <div class="small muted">Filter families by gothram or region. Only public fields shown.</div>

                  <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                    <select id="filterGothram" class="input" style="max-width:220px" onchange="loadExplore()">
                      <option value="">All Gothrams</option>
                      <option value="Bharadvaja">Bharadvaja</option>
                      <option value="Kashyapa">Kashyapa</option>
                      <option value="Atri">Atri</option>
                      <option value="Vasishtha">Vasishtha</option>
                    </select>

                    <select id="filterRegion" class="input" style="max-width:220px" onchange="loadExplore()">
                      <option value="">All Regions</option>
                      <option value="Palakkad">Palakkad</option>
                      <option value="Thanjavur">Thanjavur</option>
                      <option value="Chennai">Chennai</option>
                      <option value="Kumbakonam">Kumbakonam</option>
                    </select>
                  </div>

                  <div id="exploreResults" class="results" style="margin-top:12px"></div>
                </div>
              </div>

              <!-- ADD FAMILY TAB -->
              <div id="tab-addFamily" style="display:none">
                <div class="card">
                  <strong>Create a New Family Network</strong>
                  <div class="small muted">Search first to avoid duplicates. New families are added as "restricted" ‚Äî only Name, Place, Gothram are public.</div>

                  <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
                    <label>Family Code (unique)</label>
                    <input id="familyCode" class="input" placeholder="e.g. IYER-1975-CHN">

                    <label>Head of Family Name</label>
                    <input id="headName" class="input" placeholder="Full name">

                    <label>Place / Town</label>
                    <input id="place" class="input" placeholder="Village / Town">

                    <label>Gothram</label>
                    <input id="gothram" class="input" placeholder="e.g. Bharadvaja">

                    <label>Other details (optional)</label>
                    <textarea id="fullDetails" class="input" rows="4" placeholder="Birth years, occupations, relations... (kept private)"></textarea>

                    <div style="display:flex;gap:8px;margin-top:6px">
                      <button class="btn" onclick="addFamily()">Create Family</button>
                      <button class="btn secondary" onclick="clearFamilyForm()">Clear</button>
                    </div>

                    <div id="addFamilyMsg" class="small muted" style="margin-top:6px"></div>
                  </div>
                </div>
              </div>

            </div>

          </div>
        </div>

      </div>

      <footer>
        <div class="small">Built for GitHub Pages + Firebase. Replace firebaseConfig below and set Firestore rules before going public.</div>
      </footer>

    </div>
  </div>

  <!-- Admin modal -->
  <div id="adminModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Admin Dashboard</strong>
        <button class="btn secondary" onclick="closeAdminModal()">Close</button>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <div style="font-weight:700;margin-bottom:8px">Pending Requests</div>
          <div id="pendingList" class="results" style="min-height:140px"></div>
        </div>

        <div style="flex:1;min-width:260px">
          <div style="font-weight:700;margin-bottom:8px">Pending Users (signed up)</div>
          <div id="pendingUsersList" class="results" style="min-height:140px"></div>
        </div>

        <div style="flex:1;min-width:260px">
          <div style="font-weight:700;margin-bottom:8px">Approved Members</div>
          <div id="approvedList" class="results" style="min-height:140px"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase + App logic -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    /*****************************************************************
     * BEFORE DEPLOY:
     * - Replace firebaseConfig with your Firebase project values.
     * - Enable Email/Password sign-in in Firebase Authentication.
     * - Configure Firestore rules carefully (examples below).
     * - Test flows on a staging project before going public.
     *****************************************************************/

    const firebaseConfig = {
      apiKey: "REPLACE_API_KEY",
      authDomain: "REPLACE_AUTH_DOMAIN",
      projectId: "REPLACE_PROJECT_ID",
      // ... rest of config values
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // App state
    let currentUser = null;
    let searchTimeout = null;

    // ---------- UI helpers ----------
    function showTab(key){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t=>{ if(t.dataset.tab===key) t.classList.add('active') });
      ['search','myNetwork','explore','addFamily'].forEach(k=>{
        const el = document.getElementById('tab-'+k);
        if(el) el.style.display = (k===key? 'block' : 'none');
      });
    }

    function showAuthOptions(){ document.getElementById('requestForm').style.display='none'; document.getElementById('authOptions').style.display='block'; }
    function showSignUp(){ document.getElementById('authOptions').style.display='none'; document.getElementById('signUpForm').style.display='block'; document.getElementById('loginForm').style.display='none'; }
    function showLogin(){ document.getElementById('authOptions').style.display='none'; document.getElementById('loginForm').style.display='block'; document.getElementById('signUpForm').style.display='none'; }
    function hideAuthForms(){ document.getElementById('authOptions').style.display='none'; document.getElementById('loginForm').style.display='none'; document.getElementById('signUpForm').style.display='none'; document.getElementById('requestForm').style.display='block'; }

    function setState(text){ document.getElementById('currentState').textContent = text }

    // ---------- Auth / Request Access ----------
    async function requestAccess(){
      const accessCode = document.getElementById('accessCode').value.trim();
      const fullName = document.getElementById('fullName').value.trim();
      const fatherName = document.getElementById('fatherName').value.trim();
      const email = document.getElementById('email').value.trim();

      const msg = document.getElementById('requestMessage');
      msg.textContent = '';

      if(!fullName || !fatherName || !email){ msg.textContent = 'Please fill all fields.'; return; }

      try{
        const existing = await db.collection('requests').where('email','==',email).get();
        if(!existing.empty){ msg.textContent = 'A pending request with this email already exists.'; return; }

        await db.collection('requests').add({ fullName, fatherName, email, accessCode, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        msg.textContent = 'Request submitted. After you receive approval, please create an account using Sign Up -> same email.';
      }catch(err){ console.error(err); msg.textContent = 'Error submitting request.' }
    }

    // Sign up flow: creates Auth user + users doc (role: pending)
    async function signUp(){
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const fullName = document.getElementById('signupFullName').value.trim();
      const msg = document.getElementById('signupMessage'); msg.textContent='';
      if(!email || !password || !fullName){ msg.textContent='Please provide name, email and password.'; return; }
      if(password.length < 6){ msg.textContent = 'Password must be at least 6 characters.'; return; }

      try{
        const res = await auth.createUserWithEmailAndPassword(email, password);
        // create users doc with uid as key to simplify lookups
        await db.collection('users').doc(res.user.uid).set({ fullName, email, role:'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        msg.textContent = 'Account created. Waiting for admin approval. You can sign out and return later.';
        // signOut(); // keep signed in to show awaiting approval state handled by onAuthStateChanged
      }catch(err){ console.error(err); msg.textContent = 'Sign up failed: '+(err.message || err.code); }
    }

    // Sign in
    async function signIn(){
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const msg = document.getElementById('loginMessage'); msg.textContent='';
      if(!email || !password){ msg.textContent='Provide email and password.'; return; }

      try{
        await auth.signInWithEmailAndPassword(email,password);
        // onAuthStateChanged will update UI
      }catch(err){ console.error(err); msg.textContent = 'Sign-in failed. Check credentials.'; }
    }

    function signOut(){ auth.signOut(); }

    // Watch auth state
    auth.onAuthStateChanged(async (user)=>{
      currentUser = user;
      if(user){
        // fetch user's role from users collection (doc id = uid when created via signUp)
        const udoc = await db.collection('users').doc(user.uid).get();
        const data = udoc.exists ? udoc.data() : null;

        if(!data){
          // user exists in auth but we don't have a users doc yet. Create a pending users doc so admin can approve
          await db.collection('users').doc(user.uid).set({ fullName: user.displayName || '', email: user.email, role:'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          setState(user.email + ' ‚Äî awaiting approval');
          document.getElementById('btnSignOut').style.display='inline-block';
          document.getElementById('requestForm').style.display='none';
          document.getElementById('loginForm').style.display='none';
          document.getElementById('adminPanel').style.display='none';
          return;
        }

        if(data.role === 'pending'){
          setState((data.fullName || user.email) + ' ‚Äî Awaiting admin approval');
          document.getElementById('btnSignOut').style.display='inline-block';
          document.getElementById('requestForm').style.display='none';
          document.getElementById('loginForm').style.display='none';
          document.getElementById('adminPanel').style.display='none';
          return;
        }

        if(data.role === 'blocked'){
          setState((data.fullName || user.email) + ' ‚Äî Access blocked by admin');
          document.getElementById('btnSignOut').style.display='inline-block';
          document.getElementById('adminPanel').style.display='none';
          return;
        }

        // approved (or admin)
        setState((data.fullName || user.email) + (data.role === 'admin' ? ' ‚Äî Admin' : ''));
        document.getElementById('btnSignOut').style.display='inline-block';
        document.getElementById('requestForm').style.display='none';
        document.getElementById('loginForm').style.display='none';
        document.getElementById('adminPanel').style.display = (data.role === 'admin') ? 'block' : 'none';

      }else{
        // no user signed in
        setState('Not signed in');
        document.getElementById('btnSignOut').style.display='none';
        document.getElementById('requestForm').style.display='block';
        document.getElementById('loginForm').style.display='none';
        document.getElementById('adminPanel').style.display = 'none';
      }
    });

    // ---------- Admin modal ----------
    async function openAdminModal(){
      document.getElementById('adminModalBackdrop').style.display='flex';
      await loadPendingRequests();
      await loadPendingUsers();
      await loadApprovedMembers();
    }
    function closeAdminModal(){ document.getElementById('adminModalBackdrop').style.display='none'; }

    async function loadPendingRequests(){
      const list = document.getElementById('pendingList'); list.innerHTML='Loading...';
      const snapshot = await db.collection('requests').orderBy('createdAt','asc').get();
      if(snapshot.empty){ list.innerHTML = '<div class="small muted">No pending requests</div>'; return; }
      list.innerHTML = '';
      snapshot.forEach(doc=>{
        const r = doc.data();
        const div = document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(r.fullName)}</div><div class="small muted">${escapeHtml(r.email)}</div></div>`;
        const actions = document.createElement('div'); actions.className='flex';
        const btnApprove = document.createElement('button'); btnApprove.className='btn'; btnApprove.textContent='Approve';
        btnApprove.onclick = ()=>approveRequest(doc.id, r);
        const btnReject = document.createElement('button'); btnReject.className='btn secondary'; btnReject.textContent='Reject';
        btnReject.onclick = ()=>rejectRequest(doc.id);
        actions.appendChild(btnApprove); actions.appendChild(btnReject);
        div.appendChild(actions);
        list.appendChild(div);
      })
    }

    async function loadPendingUsers(){
      const list = document.getElementById('pendingUsersList'); list.innerHTML='Loading...';
      const snapshot = await db.collection('users').where('role','==','pending').get();
      if(snapshot.empty){ list.innerHTML = '<div class="small muted">No pending users</div>'; return; }
      list.innerHTML = '';
      snapshot.forEach(doc=>{
        const u = doc.data();
        const div = document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(u.fullName)}</div><div class="small muted">${escapeHtml(u.email)}</div></div>`;
        const actions = document.createElement('div'); actions.className='flex';
        const btnApprove = document.createElement('button'); btnApprove.className='btn'; btnApprove.textContent='Approve';
        btnApprove.onclick = ()=>approveUser(doc.id);
        const btnBlock = document.createElement('button'); btnBlock.className='btn secondary'; btnBlock.textContent='Block';
        btnBlock.onclick = ()=>blockMember(doc.id);
        actions.appendChild(btnApprove); actions.appendChild(btnBlock);
        div.appendChild(actions);
        list.appendChild(div);
      })
    }

    async function loadApprovedMembers(){
      const list = document.getElementById('approvedList'); list.innerHTML='Loading...';
      const snapshot = await db.collection('users').where('role','in',['approved','admin']).get();
      if(snapshot.empty){ list.innerHTML = '<div class="small muted">No approved members</div>'; return; }
      list.innerHTML = '';
      snapshot.forEach(doc=>{
        const u = doc.data();
        const div = document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(u.fullName)}</div><div class="small muted">${escapeHtml(u.email)} ‚Ä¢ ${escapeHtml(u.role || '')}</div></div>`;
        const actions = document.createElement('div'); actions.className='flex';
        const btnBlock = document.createElement('button'); btnBlock.className='btn secondary'; btnBlock.textContent='Block';
        btnBlock.onclick = ()=>blockMember(doc.id);
        actions.appendChild(btnBlock);
        if(u.role !== 'admin'){
          const btnMakeAdmin = document.createElement('button'); btnMakeAdmin.className='btn'; btnMakeAdmin.textContent='Make Admin';
          btnMakeAdmin.onclick = ()=>makeAdmin(doc.id);
          actions.appendChild(btnMakeAdmin);
        }
        div.appendChild(actions);
        list.appendChild(div);
      })
    }

    // Approve a request: prefer to update existing users doc (by email), else create an approved user doc and notify admin
    async function approveRequest(requestId, requestData){
      try{
        // check if a users doc exists with this email
        const usersSnap = await db.collection('users').where('email','==',requestData.email).get();
        if(!usersSnap.empty){
          // update all matches to approved
          const batch = db.batch();
          usersSnap.forEach(d=> batch.update(db.collection('users').doc(d.id), { role: 'approved' }));
          await batch.commit();
        }else{
          // create a users doc without uid (admin should ask user to sign up or create auth user manually)
          await db.collection('users').add({ fullName: requestData.fullName, fatherName: requestData.fatherName, email: requestData.email, role:'approved', createdAt: firebase.firestore.FieldValue.serverTimestamp(), note:'Please ask user to sign up with this email.' });
        }

        await db.collection('requests').doc(requestId).delete();
        alert('Request approved. If the user has already signed up, they can sign in. If not, ask them to Sign Up with the same email.');
        await loadPendingRequests(); await loadPendingUsers(); await loadApprovedMembers();
      }catch(err){ console.error(err); alert('Error approving request: '+(err.message||err)); }
    }

    // Approve a signed-up user (docId is uid doc or auto-id). Prefer doc id that matches uid.
    async function approveUser(docId){
      if(!confirm('Approve this user?')) return;
      try{ await db.collection('users').doc(docId).update({ role:'approved' }); await loadPendingUsers(); await loadApprovedMembers(); alert('User approved.'); }catch(err){ console.error(err); alert('Error: '+(err.message||err)); }
    }

    async function rejectRequest(requestId){ if(!confirm('Reject this request?')) return; await db.collection('requests').doc(requestId).delete(); await loadPendingRequests(); }
    async function blockMember(docId){ if(!confirm('Block this member?')) return; await db.collection('users').doc(docId).update({role:'blocked'}); await loadPendingUsers(); await loadApprovedMembers(); }
    async function makeAdmin(docId){ if(!confirm('Make this member an admin?')) return; await db.collection('users').doc(docId).update({role:'admin'}); await loadApprovedMembers(); }

    // ---------- Family Create / Search ----------
    async function addFamily(){
      const familyCode = document.getElementById('familyCode').value.trim();
      const headName = document.getElementById('headName').value.trim();
      const place = document.getElementById('place').value.trim();
      const gothram = document.getElementById('gothram').value.trim();
      const fullDetails = document.getElementById('fullDetails').value.trim();
      const msg = document.getElementById('addFamilyMsg'); msg.textContent='';
      if(!familyCode || !headName || !place || !gothram){ msg.textContent='Please fill required fields.'; return; }

      try{
        // ensure unique family code
        const exists = await db.collection('families').where('familyCode','==',familyCode).get();
        if(!exists.empty){ msg.textContent='Family code already exists. Choose another unique code.'; return; }

        await db.collection('families').add({ familyCode, headName, place, gothram, fullDetails, createdBy: currentUser ? currentUser.uid : null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

        msg.textContent = 'Family created. Public fields are visible to all members. Private details remain hidden; request via admin if needed.';
        clearFamilyForm();
        loadExplore();
      }catch(err){ console.error(err); msg.textContent='Error creating family.' }
    }
    function clearFamilyForm(){ ['familyCode','headName','place','gothram','fullDetails'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); document.getElementById('addFamilyMsg').textContent=''; }

    // minimal XSS escape
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]}) }

    // Search families (only show name/place/gothram in results)
    async function searchFamilies(q){
      const out = document.getElementById('searchResults'); out.innerHTML='Searching...';
      if(!q) { out.innerHTML=''; return; }
      const qLower = q.toLowerCase();

      // naive client-side search: fetch limited number of documents then filter
      const snapshot = await db.collection('families').orderBy('createdAt','desc').limit(200).get();
      const items = [];
      snapshot.forEach(doc=>{
        const d = doc.data();
        const combined = ((d.headName||'') + ' ' + (d.familyCode||'') + ' ' + (d.gothram||'') + ' ' + (d.place||'')).toLowerCase();
        if(combined.indexOf(qLower) !== -1) items.push({id:doc.id, data:d});
      });

      if(items.length===0){ out.innerHTML = '<div class="small muted">No matches</div>'; return; }
      out.innerHTML='';
      items.forEach(it=>{
        const d = it.data; const div = document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(d.headName)}</div><div class="small muted">${escapeHtml(d.place)} ‚Ä¢ ${escapeHtml(d.gothram)} ‚Ä¢ Code: ${escapeHtml(d.familyCode||'')}</div></div>`;
        const actions = document.createElement('div'); actions.className='flex';
        const btnView = document.createElement('button'); btnView.className='btn secondary'; btnView.textContent='View'; btnView.onclick = ()=>viewFamilyPreview(it.id);
        const btnRequest = document.createElement('button'); btnRequest.className='btn'; btnRequest.textContent='Request Details'; btnRequest.onclick = ()=>requestDetails(it.id);
        actions.appendChild(btnView); actions.appendChild(btnRequest);
        div.appendChild(actions);
        out.appendChild(div);
      })
    }

    function debouncedSearch(){ clearTimeout(searchTimeout); const q = document.getElementById('searchInput').value.trim(); searchTimeout = setTimeout(()=>searchFamilies(q), 350); }
    function clearSearch(){ document.getElementById('searchInput').value=''; document.getElementById('searchResults').innerHTML=''; }

    async function viewFamilyPreview(docId){
      const doc = await db.collection('families').doc(docId).get();
      if(!doc.exists){ alert('Family not found'); return; }
      const d = doc.data();
      const el = document.getElementById('familyPreview');
      el.innerHTML = '';

      // Render a simple preview using public fields only
      const node = document.createElement('div'); node.className='node current'; node.innerHTML = `<div style="font-weight:700">${escapeHtml(d.headName)}</div><div class="small muted">${escapeHtml(d.place)}</div><div class="small muted">${escapeHtml(d.gothram)}</div>`;
      el.appendChild(node);

      // store last selected
      el.dataset.familyId = docId;
      showTab('myNetwork');
    }

    async function requestDetails(familyId){
      if(!currentUser){ alert('Sign in to request details'); return; }
      await db.collection('detailRequests').add({ familyId, requestedBy: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'pending' });
      alert('Request submitted to admin. You will be notified when approved.');
    }

    // Explore families with filters
    async function loadExplore(){
      const gothram = document.getElementById('filterGothram').value;
      const region = document.getElementById('filterRegion').value;
      const out = document.getElementById('exploreResults'); out.innerHTML='Loading...';
      let q = db.collection('families').orderBy('createdAt','desc').limit(500);
      const snapshot = await q.get();
      const items = [];
      snapshot.forEach(doc=>{
        const d = doc.data();
        if(gothram && d.gothram !== gothram) return;
        if(region && d.place !== region) return;
        items.push({id:doc.id,data:d});
      });
      if(items.length===0){ out.innerHTML='<div class="small muted">No families found</div>'; return; }
      out.innerHTML='';
      items.forEach(it=>{
        const d = it.data; const div = document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(d.headName)}</div><div class="small muted">${escapeHtml(d.place)} ‚Ä¢ ${escapeHtml(d.gothram)}</div></div>`;
        const actions = document.createElement('div'); actions.className='flex';
        const btnView = document.createElement('button'); btnView.className='btn secondary'; btnView.textContent='View'; btnView.onclick = ()=>viewFamilyPreview(it.id);
        actions.appendChild(btnView);
        div.appendChild(actions);
        out.appendChild(div);
      })
    }

    // ---------- Misc ----------
    async function requestExport(){ const el = document.getElementById('familyPreview'); if(!el.dataset.familyId) { alert('Select a family first'); return; } await requestDetails(el.dataset.familyId); }
    function shareFamilyLink(){ const el = document.getElementById('familyPreview'); if(!el.dataset.familyId){ alert('Select a family first'); return; } prompt('Share this family code with others', el.dataset.familyId); }

    // ---------- small helpers and initialization ----------
    (function init(){
      // initial explore list
      loadExplore();
      document.getElementById('adminPanel').style.display='none';
    })();

  </script>
</body>
</html>
