<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Tree App</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0;}
  header { background:#800000; color:white; padding:1rem; text-align:center;}
  .container { max-width:900px; margin:2rem auto; padding:2rem; background:white; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
  input, select, button, textarea { width:100%; padding:0.5rem; margin:0.5rem 0; border-radius:5px; border:1px solid #ccc;}
  button { background:#800000; color:white; border:none; cursor:pointer;}
  button:hover { background:#a00000; }
  .hidden { display:none;}
  .family-entry { padding:1rem; border-bottom:1px solid #ccc;}
  .family-entry button { width:auto; margin-left:0.5rem;}
  .approved { color:green; }
  .pending { color:orange; }
  .blocked { color:red; }
  #modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000;}
  #modal { background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; }
  #modal h3 { margin-top:0; }
  #message { margin:0.5rem 0; color:green; }
  #treeContainer { margin-top:2rem; overflow-x:auto; border:1px solid #ccc; padding:1rem; border-radius:10px; background:#fff;}
</style>
<!-- Include Treant.js for tree diagram -->
<link rel="stylesheet" href="https://fperucic.github.io/treant-js/Treant.css">
<script src="https://fperucic.github.io/treant-js/vendor/raphael.js"></script>
<script src="https://fperucic.github.io/treant-js/Treant.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDiE8jLUA3lA1mTfBhDH_KQQ5J_sLbGQk8",
  authDomain: "kulam-family-tree.firebaseapp.com",
  projectId: "kulam-family-tree",
  storageBucket: "kulam-family-tree.firebasestorage.app",
  messagingSenderId: "219860158687",
  appId: "1:219860158687:web:a2eefd26049298fcdb016a",
  measurementId: "G-74J5ZKDEDX"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

// Elements
const loginDiv = document.getElementById('loginDiv');
const dashboardDiv = document.getElementById('dashboardDiv');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const registerBtn = document.getElementById('registerBtn');
const familyForm = document.getElementById('familyForm');
const familyList = document.getElementById('familyList');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const messageDiv = document.getElementById('message');
const adminPanel = document.getElementById('adminPanel');
const modalOverlay = document.getElementById('modalOverlay');
const modal = document.getElementById('modal');
const treeContainer = document.getElementById('treeContainer');

let currentUser = null;
let isAdmin = false;

// Auth state
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    const userDocSnap = await getDoc(doc(db,'users',user.uid));
    if(userDocSnap.exists()){
      const data = userDocSnap.data();
      isAdmin = data.isAdmin || false;
      if(data.blocked){
        alert('You are blocked by admin.');
        signOut(auth);
        return;
      }
    }
    loginDiv.classList.add('hidden');
    dashboardDiv.classList.remove('hidden');
    loadFamilyEntries();
    renderTree();
    if(isAdmin) adminPanel.classList.remove('hidden');
    else adminPanel.classList.add('hidden');
  } else {
    currentUser = null;
    isAdmin = false;
    loginDiv.classList.remove('hidden');
    dashboardDiv.classList.add('hidden');
  }
});

// Register
registerBtn.addEventListener('click', async ()=>{
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
    await setDoc(doc(db,'users',userCredential.user.uid),{uid:userCredential.user.uid,isAdmin:false,blocked:false});
    messageDiv.innerText = 'Registered successfully.';
  }catch(e){ alert(e.message); }
});

// Login
loginBtn.addEventListener('click', async ()=>{
  try{
    const userCredential = await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
    const userDocSnap = await getDoc(doc(db,'users',userCredential.user.uid));
    if(userDocSnap.exists() && userDocSnap.data().blocked){
      alert('Your account is blocked by admin.');
      signOut(auth);
    }
  }catch(e){ alert(e.message); }
});

// Logout
logoutBtn.addEventListener('click', ()=>signOut(auth));

// Add Family Entry
familyForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    await addDoc(collection(db,'familyTree'),{
      addedBy: currentUser.uid,
      name: familyForm.name.value,
      nickname: familyForm.nickname.value,
      place: familyForm.place.value,
      gothram: familyForm.gothram.value,
      married: familyForm.married.value,
      phone: familyForm.phone.value,
      approved: false,
      edits: [],
      requests: [],
      parentId: familyForm.parentId ? familyForm.parentId.value : null // For tree hierarchy
    });
    messageDiv.innerText = 'Family entry added, pending admin approval.';
    familyForm.reset();
    loadFamilyEntries();
    renderTree();
  }catch(e){alert(e.message);}
});

// Load Family Entries
async function loadFamilyEntries(queryText=''){
  familyList.innerHTML='';
  let q = collection(db,'familyTree');
  if(queryText){
    q = query(collection(db,'familyTree'), where('name','>=', queryText), where('name','<=', queryText+'\uf8ff'));
  }
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement('div');
    div.classList.add('family-entry');
    div.innerHTML = `<strong>${data.name}</strong> | ${data.place || '-'} | ${data.gothram || '-'}
      ${data.approved ? '<span class="approved">(Approved)</span>' : '<span class="pending">(Pending)</span>'}`;

    // Edit button
    const editBtn = document.createElement('button');
    editBtn.innerText = 'Edit';
    editBtn.onclick = ()=>openEditModal(docSnap.id,data);
    div.appendChild(editBtn);

    // Request full details
    const requestBtn = document.createElement('button');
    requestBtn.innerText = 'Request Full Details';
    requestBtn.onclick = ()=>requestFullDetails(docSnap.id,data);
    div.appendChild(requestBtn);

    // Admin buttons
    if(isAdmin){
      if(!data.approved){
        const approveBtn = document.createElement('button');
        approveBtn.innerText='Approve';
        approveBtn.onclick=async()=>{
          await updateDoc(doc(db,'familyTree',docSnap.id),{approved:true});
          loadFamilyEntries();
          renderTree();
        };
        div.appendChild(approveBtn);
      }

      // Access requests
      if(data.requests && data.requests.length>0){
        data.requests.forEach((req,i)=>{
          const reqBtn = document.createElement('button');
          reqBtn.innerText=`Approve Access #${i+1}`;
          reqBtn.onclick=async()=>{
            const requests = [...data.requests];
            requests.splice(i,1);
            await updateDoc(doc(db,'familyTree',docSnap.id),{
              requests,
              [`fullAccess_${req.uid}`]:true
            });
            loadFamilyEntries();
          };
          div.appendChild(reqBtn);
        });
      }

      // Block/unblock member
      const userBtn = document.createElement('button');
      userBtn.innerText = data.blocked ? 'Unblock Member' : 'Block Member';
      userBtn.onclick=async()=>{
        await updateDoc(doc(db,'users',data.addedBy),{blocked:!data.blocked});
        loadFamilyEntries();
      };
      div.appendChild(userBtn);
    }

    familyList.appendChild(div);
  });
}

// Search
searchBtn.addEventListener('click', ()=>loadFamilyEntries(searchInput.value));

// Edit Modal
function openEditModal(id,data){
  modalOverlay.style.display='flex';
  modal.innerHTML = `
    <h3>Edit Family Entry</h3>
    <input type="text" id="editName" placeholder="Name" value="${data.name}">
    <input type="text" id="editNickname" placeholder="Nickname" value="${data.nickname || ''}">
    <input type="text" id="editPlace" placeholder="Place" value="${data.place || ''}">
    <input type="text" id="editGothram" placeholder="Gothram" value="${data.gothram || ''}">
    <select id="editMarried">
      <option value="">Marital Status</option>
      <option value="Married" ${data.married==='Married'?'selected':''}>Married</option>
      <option value="Unmarried" ${data.married==='Unmarried'?'selected':''}>Unmarried</option>
    </select>
    <input type="text" id="editPhone" placeholder="Phone" value="${data.phone || ''}">
    <button id="saveEditBtn">Save Edit</button>
    <button id="closeModalBtn">Cancel</button>
  `;
  document.getElementById('closeModalBtn').onclick = ()=>{ modalOverlay.style.display='none'; };
  document.getElementById('saveEditBtn').onclick = async ()=>{
    const editData = {
      name: document.getElementById('editName').value,
      nickname: document.getElementById('editNickname').value,
      place: document.getElementById('editPlace').value,
      gothram: document.getElementById('editGothram').value,
      married: document.getElementById('editMarried').value,
      phone: document.getElementById('editPhone').value
    };
    await addDoc(collection(db,'familyTreeEdits'),{
      originalId:id,
      newData:editData,
      requestedBy:currentUser.uid,
      approved:false
    });
    messageDiv.innerText='Edit request submitted, pending admin approval.';
    modalOverlay.style.display='none';
  };
}

// Request Full Details
async function requestFullDetails(id,data){
  const uid = currentUser.uid;
  if(data[`fullAccess_${uid}`]){
    openFullDetailsModal(data);
    return;
  }
  const requests = data.requests || [];
  if(!requests.find(r=>r.uid===uid)) requests.push({uid});
  await updateDoc(doc(db,'familyTree',id),{requests});
  messageDiv.innerText='Request submitted. Admin approval needed.';
}

// Full Details Modal
function openFullDetailsModal(data){
  modalOverlay.style.display='flex';
  modal.innerHTML = `<h3>Full Details: ${data.name}</h3>
    <p><strong>Nickname:</strong> ${data.nickname || '-'}</p>
    <p><strong>Place:</strong> ${data.place || '-'}</p>
    <p><strong>Gothram:</strong> ${data.gothram || '-'}</p>
    <p><strong>Married:</strong> ${data.married || '-'}</p>
    <p><strong>Phone:</strong> ${data.phone || '-'}</p>
    <button id="closeModalBtn">Close</button>`;
  document.getElementById('closeModalBtn').onclick = ()=>{ modalOverlay.style.display='none'; };
}

// Render Tree Diagram
async function renderTree(){
  treeContainer.innerHTML='';
  const snapshot = await getDocs(collection(db,'familyTree'));
  const nodes = [];
  const nodeMap = {};
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    if(data.approved){
      const node = { text:{name:data.name}, children:[], id:docSnap.id, full:data };
      nodeMap[docSnap.id] = node;
      nodes.push(node);
    }
  });
  const roots = [];
  // Build hierarchy
  Object.values(nodeMap).forEach(node=>{
    const parentId = node.full.parentId;
    if(parentId && nodeMap[parentId]){
      nodeMap[parentId].children.push(node);
    } else {
      roots.push(node);
    }
  });

  // Convert to Treant.js config
  const treeConfig = {
    chart: { container: "#treeContainer" },
    nodeStructure: roots[0] || { text:{name:"No members yet"} }
  };

  new Treant(treeConfig);
}
</script>
</head>
<body>
<header>
<h1>Family Tree Portal</h1>
</header>

<div class="container" id="loginDiv">
  <h2>Login / Register</h2>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
</div>

<div class="container hidden" id="dashboardDiv">
  <button id="logoutBtn">Logout</button>
  <h2>Dashboard</h2>

  <h3>Add Family Member</h3>
  <form id="familyForm">
    <input type="text" name="name" placeholder="Name" required>
    <input type="text" name="nickname" placeholder="Nickname">
    <input type="text" name="place" placeholder="Place">
    <input type="text" name="gothram" placeholder="Gothram">
    <select name="married">
      <option value="">Marital Status</option>
      <option value="Married">Married</option>
      <option value="Unmarried">Unmarried</option>
    </select>
    <input type="text" name="phone" placeholder="Phone Number">
    <input type="hidden" name="parentId" placeholder="Parent ID">
    <button type="submit">Add</button>
  </form>
  <div id="message"></div>

  <h3>Search Family</h3>
  <input type="text" id="searchInput" placeholder="Enter Name to search">
  <button id="searchBtn">Search</button>

  <h3>Family Tree Entries</h3>
  <div id="familyList"></div>

  <h3>Family Tree Diagram</h3>
  <div id="treeContainer"></div>

  <div id="adminPanel" class="hidden">
    <h3>Admin Panel</h3>
    <p>Approve pending entries, edits, access requests, block/unblock members here.</p>
  </div>
</div>

<div id="modalOverlay">
  <div id="modal"></div>
</div>
</body>
</html>
